(function(){var e,a,r,o;r=this,r.leaf={map:null,map_tiles:null,my_lat:"",my_lng:"",drawn_items:null,districts:null,searched_address:"",init:function(e){return leaf.map=L.map("map",{scrollWheelZoom:!1}),leaf.map.on("click",function(){return leaf.map.scrollWheelZoom.enabled()?leaf.map.scrollWheelZoom.disable():leaf.map.scrollWheelZoom.enable()}),leaf.my_lat=e.latitude,leaf.my_lng=e.longitude,leaf.searched_address=e.searched_address,"map_quest"===e.chosen_map?leaf.map_tiles=MQ.mapLayer():"open_street_map"===e.chosen_map?leaf.map_tiles=L.tileLayer(e.osm_tile_url,{attribution:e.osm_attribution}):"mapbox"===e.chosen_map&&(leaf.map_tiles=L.tileLayer(e.mapbox_tile_url,{attribution:e.mapbox_attribution})),leaf.map_tiles.addTo(leaf.map),leaf.map.setView([leaf.my_lat,leaf.my_lng],e.zoom_level),"none"!==e.clickable_map_marker?leaf.map.on("click",onMapClickLocation):void 0},show_features_on_ad_details_page:function(e){var a,r,o,t,l,i;if(e.ad_show_is_area===!0)"district"===e.loc_type?(r=leaf.show_single_district(e.popup_message,e.bounds),leaf.map.setView(r,e.zoom_level)):(a=new L.circle([leaf.my_lat,leaf.my_lng],600,{color:markers.postal_code_area_color,fillColor:markers.postal_code_area_color,fillOpacity:.3}),a.addTo(leaf.map).bindPopup(e.popup_message).openPopup(),leaf.map.setView([leaf.my_lat,leaf.my_lng],e.zoom_level));else{for(markers.group=new L.markerClusterGroup({spiderfyDistanceMultiplier:2}),o=0;o<e.ad_show.length;)l=e.ad_show[o],t=L.AwesomeMarkers.icon({prefix:"fa",markerColor:l.color,icon:l.icon}),i=L.marker([leaf.my_lat,leaf.my_lng],{icon:t}),""!==e.marker_message&&i.bindPopup(e.marker_message+" - "+l.item_name).openPopup(),markers.group.addLayer(i),o++;leaf.map.addLayer(markers.group),leaf.map.setView([leaf.my_lat,leaf.my_lng],e.zoom_level)}},show_single_marker:function(e){var a;"postal"===e.loc_type?(markers.postal_code_circle=new L.circle([leaf.my_lat,leaf.my_lng],600,{color:markers.postal_code_area_color,fillColor:markers.postal_code_area_color,fillOpacity:.3}),markers.postal_code_circle.addTo(leaf.map).bindPopup(e.marker_message).openPopup()):"district"===e.loc_type?leaf.show_single_district(e.marker_message,e.bounds):(a=L.marker([leaf.my_lat,leaf.my_lng],{icon:markers.default_icon}),""!==e.marker_message?a.addTo(leaf.map).bindPopup(e.marker_message).openPopup():a.addTo(leaf.map))},show_single_district:function(e,a){var r;return""!==markers.selected_area&&leaf.map.removeLayer(markers.selected_area),r="",L.geoJson(JSON.parse(a),{onEachFeature:function(a,o){return o.bindPopup(e),o.setStyle({color:markers.district_color}),leaf.map.addLayer(o),r=o.getBounds().getCenter(),o.openPopup(r),markers.selected_area=o}}),r}},r.markers={new_marker:"",selected_area:"",postal_code_circle:"",group:"",postal_group:"",district_group:"",default_icon:null,new_icon:null,marker_colors:null,postal_code_area_color:null,district_color:null,area_geocodes:null,location_marker_type:null,center_marker:null,init:function(e){markers.default_icon=L.icon({iconUrl:e.default_marker_icon,iconAnchor:[12,41],popupAnchor:[0,-34]}),markers.new_icon=L.icon({iconUrl:e.new_marker_icon,iconAnchor:[12,41],popupAnchor:[0,-34]}),markers.location_marker_type=e.clickable_map_marker,markers.district_color=e.district_color,markers.postal_code_area_color=e.postal_code_area_color},place_exact_locations_markers:function(e,a){var r,o,t,l,i,n,s;for(o=0;o<e.length;){for(r=e[o],l=0;l<r.markers.length;)t=r.markers[l],n=L.AwesomeMarkers.icon({prefix:"fa",markerColor:t.color,icon:t.icon}),i=L.marker([r.lat,r.lng],{icon:n,bounceOnAdd:a}),i.ad_id=r.ad_id,i.item_id=t.item_id,s=L.popup({minWidth:250,maxWidth:300}).setContent("Loading..."),i.bindPopup(s),i.on("click",function(e){var a;a=e.target.getPopup(),$.ajax({url:"/showAdPopup",global:!1,type:"GET",data:{ad_id:this.ad_id,item_id:this.item_id},dataType:"html",beforeSend:function(e){e.setRequestHeader("Accept","text/html-partial")},success:function(e){a.setContent(e),a.update()},error:function(e){a.setContent(e),a.update()}})}),markers.group.addLayer(i),l++;o++}},draw_postal_code_areas:function(e){null!==e&&Object.keys(e).length>0&&(markers.postal_group=L.featureGroup().addTo(leaf.map),$("#show_area_id").change(function(){$("#show_area_id").prop("checked")?drawPostalCodeAreaOnMap(e):markers.postal_group.eachLayer(function(e){markers.postal_group.removeLayer(e)})}).change())},draw_district_areas:function(e){null!==e&&Object.keys(e).length>0&&(markers.district_group=L.featureGroup().addTo(leaf.map),$("#show_area_id").change(function(){$("#show_area_id").prop("checked")?drawDistrictsOnMap(e):markers.district_group.eachLayer(function(e){markers.district_group.removeLayer(e)})}).change())}},r.initLeafletMap=function(e){return null!==leaf&&null!==leaf.map&&leaf.map.remove(),leaf.init(e),markers.init(e),e.has_center_marker===!0?$("#show_ad_page").length>0?leaf.show_features_on_ad_details_page(e):leaf.show_single_marker(e):void 0},r.drawDistrictsOnMap=function(e){Object.keys(e).forEach(function(r){var o,t,l,i;l=e[r],t=markers.area_geocodes[r].name,o=markers.area_geocodes[r].bounds,i=a(gon.vars.in_this_district+" (<b>"+t+"</b>)<br /><br />",l,"district",r),L.geoJson(JSON.parse(o),{onEachFeature:function(e,a){a.bindPopup(i),a.setStyle({color:markers.district_color}),markers.district_group.addLayer(a)}})})},r.drawPostalCodeAreaOnMap=function(e){Object.keys(e).forEach(function(r){var o,t,l;t=e[r],l=a("In this area (<b>"+r+"</b>)<br /><br />",t,"postal",r),o=L.circle([markers.area_geocodes[r].latitude,markers.area_geocodes[r].longitude],600,{color:markers.postal_code_area_color,fillColor:markers.postal_code_area_color,fillOpacity:.3}).bindPopup(l),markers.postal_group.addLayer(o)})},r.onMapClickLocation=function(e){var a,r;return r=o(e),a=r.split(","),$("#new_dynamic_button_add").removeClass("disabled"),$(".latitude").val(a[0]),$(".longitude").val(a[1])},r.find_geocodes=function(){return $("#find_geocodes_from_address").button().click(function(){var e;return e="exact",$(".location_type_postal_code").is(":checked")&&(e="area"),$.ajax({url:"/getCityGeocodes",global:!1,type:"GET",data:{street_number:$(".location_streetnumber").val(),address:$(".location_streetname").val(),city:$(".location_city").val(),postal_code:$(".location_postal_code").val(),province:$(".location_state").val(),country:$(".location_country").val(),loc_type:e},cache:!1,beforeSend:function(e){e.setRequestHeader("Accept","application/json"),e.setRequestHeader("Content-Type","application/json"),$("#findGeocodeLoaderId").html(gon.vars.searching_location)},success:function(e){var a,r;return null!==e&&"ok"===e.status?(a=Math.round(1e5*e.lat)/1e5,r=Math.round(1e5*e.lon)/1e5,$(".latitude").val(a),$(".longitude").val(r),leaf.map.setView(new L.LatLng(a,r),e.zoom_level)):$("#myErrorModal").modal("show"),$("#findGeocodeLoaderId").html("<i>"+e.address_found+"</i>")}})})},r.spiderifyMarkerGroups=function(){return""!==markers.group?markers.group.on("clusterclick",function(e){var a;return a=e.layer.getBounds().pad(.5),leaf.map.fitBounds(a)}):void 0},e=function(e,a,r){var o,t,l,i,n,s,c,_;return _="",c="",t=a.items[r],n="<a href='/ads/"+a.id+"/'>"+a.title+"</a>",i=marker_colors[t.category.marker_color],l=t.name.capitalizeFirstLetter(),s="<span style='color:"+i+"';><strong>"+l+"</strong></span>",_=a.is_giving===!0?gon.vars.items_given+"<br />"+s+": "+n+"<br />":gon.vars.items_searched+"<br />"+s+": "+n+"<br />",null!==a.image.thumb.url&&""!==a.image.thumb.url?(o="<img class='thumb_ad_image' onError=\"$('.thumb_ad_image').remove(); $('.image_notification').html('<i>"+gon.vars.image_not_available+"</i>');\" src='"+a.image.thumb.url+'\'><span class="image_notification"></span>',c="<div style='overflow: auto;'><div class='col-sm-6'>"+e+"</div><div class='col-sm-6'>"+o+"</div><div class='col-sm-12'><br>"+_+"</div></div>"):c="<div style='overflow: auto;'>"+e+"<br><br>"+_+"</div>",c},a=function(e,a,r,o){var t,l,i,n,s,c,_,m,d,p,u,f,g,k,h,y,b,v,L,w,$,C,M,P;for(_=!1,c=!1,i="<i>"+gon.vars.select_item+"</i><br /><br />",e+=i,w=gon.vars.items_given+"<br />",L=gon.vars.items_searched+"<br />",l={},M=[],n=0;n<a.length;){for(y=a[n],g=0;g<y.ads.length;){for(t=y.ads[g],k=0;k<t.items.length;)m=t.items[k],u=m.name+"|"+markers.marker_colors[m.category.marker_color],u in l?l[u].number=l[u].number+1:(l[u]={},l[u].number=1,l[u].is_giving=t.is_giving,M.push(u)),k++;g++}n++}for(M=M.sort(),s=0;s<M.length;)P=M[s],p=P.split("|"),f=p[0],b=p[1],v=l[P].number,C="<span style='color:"+b+";' >"+f.capitalizeFirstLetter()+"</span>",h=f+"|"+r+"|"+o,d=C+" ("+v+")",$="- <a href='#' class='area_link' id='"+h+"'>"+d+"</a>",l[P].is_giving===!0?(_=!0,w=w+$+"<br />"):(c=!0,L=L+$+"<br />"),s++;return!_&&c?e+=L:!c&&_?e+=w:e=e+w+"<br />"+L,e},o=function(e){var a,r;return""!==markers.new_marker&&leaf.map.removeLayer(markers.new_marker),""!==markers.postal_code_circle&&leaf.map.removeLayer(markers.postal_code_circle),a=e.latlng.lat,r=e.latlng.lng,a=Math.round(1e5*a)/1e5,r=Math.round(1e5*r)/1e5,"exact"===markers.location_marker_type?(markers.new_marker=new L.Marker(e.latlng,{icon:markers.new_icon},{draggable:!1}),leaf.map.addLayer(markers.new_marker)):"area"===markers.location_marker_type&&(markers.postal_code_circle=new L.circle(e.latlng,600,{color:markers.postal_code_area_color,fillColor:markers.postal_code_area_color,fillOpacity:.3}),markers.postal_code_circle.addTo(leaf.map)),a+","+r},String.prototype.capitalizeFirstLetter=function(){return this.charAt(0).toUpperCase()+this.slice(1)}}).call(this);