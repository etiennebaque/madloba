(function(){var t,e,a;e=this,e.AdSocket=function(){this.nav_state={cat:[],q:"",item:"",lat:"",lon:""},this.socket=new WebSocket(App.websocket_url+"/websocket"),this.initBinds()},a={refresh_map:"map",add_new_marker:"new"},t=function(t,e,a){return t=""!==t?t+"&"+e+"="+a:e+"="+a},AdSocket.prototype.stringifyState=function(){var e,a;return e=this,a="",e.nav_state.cat.length>0&&(a="cat=",a+=e.nav_state.cat.join("+")),""!==e.nav_state.item&&(a=t(a,"item",e.nav_state.item)),""!==e.nav_state.q&&(a=t(a,"q",e.nav_state.q)),""!==e.nav_state.lat&&(a=t(a,"lat",e.nav_state.lat)),""!==e.nav_state.lon&&(a=t(a,"lon",e.nav_state.lon)),a},AdSocket.prototype.initBinds=function(){var t;t=this,$("#sidebar").on("click",".guided-nav-category",function(){var e,a;return a=$(this).clone(),e=$(this).attr("id"),t.nav_state.cat.indexOf(e)>-1?(a.find("i.align-cross").remove(),$("#available_categories").append(a.prop("outerHTML")),$(this).remove(),t.nav_state.cat=jQuery.grep(t.nav_state.cat,function(t){return t!==e}),0===t.nav_state.cat.length&&$("#refinements").html("")):(a.append("<i class='glyphicon glyphicon-remove align-cross' style='float: right;'></i>"),$("#refinements").append(a.prop("outerHTML")),$(this).remove(),t.nav_state.cat.push($(this).attr("id"))),t.sendNavState(t.stringifyState())}),$(document).ready(function(){var e;e=$("#new_ad_id").val(),"undefined"!=typeof e&&t.sendNewAdNotification(e)}),this.socket.onmessage=function(e){var a,r,n,o;switch(n=JSON.parse(e.data),o=n.status,a=n.map_info,r=t.nav_state,o){case"mapok":t.refresh_map(a,r);break;case"error":t.error_map(a);break;case"new_ad":t.add_marker(a)}}},AdSocket.prototype.sendNavState=function(t){this.socket.send(a.refresh_map+t)},AdSocket.prototype.sendNewAdNotification=function(t){this.send(a.add_new_marker+t)},AdSocket.prototype.refresh_map=function(t,e){""!==markers.group&&markers.group.clearLayers(),""!==markers.postal_group&&markers.postal_group.clearLayers(),""!==markers.district_group&&markers.district_group.clearLayers(),""!==t.markers&&markers.place_exact_locations_markers(t.markers,!1),""!==t.postal&&drawPostalCodeAreaOnMap(t.postal),""!==t.district&&drawDistrictsOnMap(t.district)},AdSocket.prototype.updateURL=function(t){var e,a,r,n,o,s,i;if(i=location.search,a=window.location.href,n="cat="+t.cat.join("+"),o="",""!==i){for(s=i.replace("?","").split("&"),e="",r=0;r<s.length;){if(s[r].indexOf("cat=")>-1){e=s[r];break}r++}o=""!==e?"cat="===n?a.replace(e,""):a.replace(e,n):a+"&"+n}else o="cat="===n?a:a+"?"+n;o.indexOf("?#")>-1&&(o=o.replace("?#","")),history.replaceState("data","",o)},AdSocket.prototype.error_map=function(t){$("#search_error_message").html(t)},AdSocket.prototype.add_marker=function(t){var e,a;e=t.markers,a=e[0].markers.length>1,a?markers.place_exact_locations_markers(e,!1):markers.place_exact_locations_markers(e,!0)},AdSocket.prototype.send=function(t){var e;e=this.socket,this.waitForConnection(function(){e.send(t)},1e3)},AdSocket.prototype.waitForConnection=function(t,e){var a;1===this.socket.readyState?t():(a=this,setTimeout(function(){a.waitForConnection(t,e)},e))}}).call(this);